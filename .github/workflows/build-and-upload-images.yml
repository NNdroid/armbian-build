name: Build and Upload Images

on:
#  push:
#    branches: [ "main" ]
#  pull_request:
#    branches: [ "main" ]
  workflow_dispatch:
  schedule:
    - cron: '10 13 * * *'

permissions:
  contents: write
  actions: write # 需要此权限来取消 Workflow

jobs:
  build:
    name: Build on Ubuntu 24.04
    runs-on: ubuntu-24.04
    # 【修复 1】: 移除 container 块
    # 直接在 VM Host 上运行，避免 "容器内套容器" 或 "容器内修改内核参数" 的权限问题。
    # Armbian 脚本通常会自动拉取它需要的 Docker 环境，或者利用 Host 环境。

    steps:
      - name: Checkout Upstream to Check Tags (Schedule only)
        id: check
        if: github.event_name == 'schedule'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "Cloning upstream repo metadata..."
          
          # 1. 浅克隆 (公开仓库不需要 Token)
          git clone --bare --filter=blob:none https://github.com/armbian/build.git upstream_check
          
          cd upstream_check
          
          # 2. 获取数据
          LATEST_TAG_INFO=$(git for-each-ref --sort=-creatordate --format='%(creatordate:unix) %(refname:short)' refs/tags | head -n 1)
          
          if [ -z "$LATEST_TAG_INFO" ]; then
             echo "Error: No tags found."
             cd ..
             rm -rf upstream_check
             exit 1
          fi
          
          TAG_TIMESTAMP=$(echo "$LATEST_TAG_INFO" | awk '{print $1}')
          TAG_NAME=$(echo "$LATEST_TAG_INFO" | awk '{print $2}')
          TAG_DATE=$(date -d @$TAG_TIMESTAMP +'%Y-%m-%d %H:%M:%S')
          
          # 3. 清理
          cd ..
          rm -rf upstream_check
          
          echo "Latest Upstream Tag: $TAG_NAME ($TAG_DATE)"
          
          # 4. 判断逻辑
          NOW_TIMESTAMP=$(date +%s)
          DIFF=$((NOW_TIMESTAMP - TAG_TIMESTAMP))
          
          if [ "$DIFF" -gt 86400 ]; then
            echo "Result: Latest tag is older than 24 hours. Skipping build."
            echo "Cancelling this workflow run..."
            echo "should_build=false" >> $GITHUB_OUTPUT
            sleep 60
          else
            echo "Result: New tag found within 24 hours. Proceeding..."
            echo "should_build=true" >> $GITHUB_OUTPUT
          fi

      #如果不需要构建，直接取消 (Fail Fast)
      - name: Cancel Run if No Update
        if: github.event_name == 'schedule' && steps.check.outputs.should_build == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            core.notice('No new tags in the last 24 hours. Cancelling workflow.');
            await github.rest.actions.cancelWorkflowRun({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: context.runId
            });
            // 等待取消生效
            await new Promise(r => setTimeout(r, 60000));

      # 1. 检出代码
      - name: Checkout code
        uses: actions/checkout@v4

      # --- 修正：清理磁盘空间 ---
      - name: Free Disk Space (Ubuntu)
        # 修正了仓库名称：去掉末尾的 "-action"
        uses: jlumbroso/free-disk-space@v1.3.1
        with:
          # 释放 Android 库 (约 10GB)
          android: true
          # 释放 .NET 运行库 (约 2GB)
          dotnet: true
          # 释放 Haskell (约 3GB)
          haskell: true
          # 释放很大的 Docker 镜像 (约 3GB)
          docker-images: true
          # 释放 CodeQL 分析工具 (约 2GB)
          tool-cache: true
          # 释放 Swap 分区 (这会增加内存压力，如果内存不够就设为 false)
          swap-storage: false
      # ------------------------

      # 【修复 2】: 使用官方 Action 配置 QEMU
      # 这会在内核层面注册 ARM64, RISCV 等架构的模拟器。
      # 这样当脚本运行 "arch-test arm64" 时就会通过，不再报错。
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      # 2. 安装基础依赖
      # 虽然在 VM 上，但为了脚本能跑起来，还是预装一些基础包
      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y git curl wget sudo qemu-user-static

      # 3. 赋予脚本执行权限
      - name: Make script executable
        run: chmod +x build.sh

      # 4. 执行构建脚本
      # 加上 sudo，Armbian 构建过程涉及 loop 设备挂载，必须要有 root 权限
      - name: Run build script
        run: ./build.sh
        
      # 5. 压缩镜像文件
      - name: Compress each .img individually and delete source
        run: |
          cd build/output/images
          # 遍历当前目录下所有的 .img 文件
          for file in *.img; do
            [ -e "$file" ] || continue
            echo "Processing: $file"
            tar -zcvf "${file%.img}.tar.gz" "$file" && rm "$file"
          done
          echo "All done. Listing remaining files:"
          ls -lh *.tar.gz

      # 6. (新增步骤) 准备版本号和文件名
      - name: Prepare Release MetaData
        id: metadata
        if: success()
        run: |
          # 2. 提取版本号
          VERSION=$(cat build/VERSION)
          
          # 3. 获取日期
          DATE=$(date +%Y%m%d)
          
          # 4. 组合 Tag 和 Name
          TAG_NAME="v${VERSION}-${DATE}"
          RELEASE_NAME="Armbian v${VERSION} Build ${DATE}"
          
          echo "Calculated Tag: $TAG_NAME"
          
          # 5. 写入 GitHub Output
          echo "release_tag=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "release_name=$RELEASE_NAME" >> $GITHUB_OUTPUT
          
          # 多行文本写入 Output 的标准写法
          echo "release_commit_log<<EOF" >> $GITHUB_OUTPUT
          git -C ./build log -1 --date=format:'%Y-%m-%d %H:%M:%S' --format="[%h](https://github.com/armbian/build/commit/%H) (%cd) by %an: %s" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          echo "date=$(date +'%Y-%m-%d')" >> $GITHUB_OUTPUT
          echo "time=$(date +'%H:%M:%S')" >> $GITHUB_OUTPUT

      # 7. 上传构建产物
      - name: Upload Artifacts
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: built-images
          path: build/output/images/*
          retention-days: 5

      # 8. 发布到 GitHub Release
      - name: Generate Release Tag & Upload
        if: github.ref == 'refs/heads/main' && success()
        uses: softprops/action-gh-release@v2
        with:
          files: build/output/images/*
          body: |
            ### Build Information
            - Commit Hash: ${{ steps.metadata.outputs.release_commit_log }}
            - Build Time: ${{ steps.metadata.outputs.date }} ${{ steps.metadata.outputs.time }}
          tag_name: ${{ steps.metadata.outputs.release_tag }}
          name: ${{ steps.metadata.outputs.release_name }}
          make_latest: true
          draft: false
          prerelease: false
